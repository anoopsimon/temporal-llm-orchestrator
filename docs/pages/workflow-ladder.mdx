---
title: Workflow Ladder
description: Exact control flow from upload to completion
---

# Workflow Ladder

This page mirrors the required decision ladder in code.

Implementation entrypoint:

- `DocumentIntakeWorkflow` in `internal/temporal/workflows.go`

## 1. Store and classify

1. `StoreDocumentActivity` -> audit `STORED`
2. `DetectDocTypeActivity` -> audit `CLASSIFIED`

## 2. Extraction phase

`ExtractFieldsWithOpenAIActivity` performs:

1. Prompt Set A (Base Extraction)
2. If parse/schema fails -> Prompt Set B (JSON Repair)
3. If still failing -> Base Extraction one fresh retry
4. Persist attempt outputs into `extraction_attempts`
5. Save normalized extraction + confidence
6. Audit `EXTRACTED`

At most:

- Base attempt 2
- Repair attempt 1

## 3. Validation and correction

1. `ValidateFieldsActivity`
2. If rules fail or confidence < `0.75`:
   - `CorrectFieldsWithOpenAIActivity` (Prompt Set C) once
   - Re-validate once

At most:

- Correction attempt 1

## 4. Review loop

If still failing or confidence < `0.75`:

1. Queue review in `review_queue`
2. Set status `NEEDS_REVIEW`
3. Wait on Temporal signal `reviewDecision`
4. Apply one of:
   - `approve` -> continue
   - `reject` -> persist rejected and stop
   - `correct` -> apply reviewer payload, validate, and either continue or stay in review loop

Signal definition:

- `internal/temporal/signals.go`

## 5. Finalization

- `PersistResultActivity` persists final JSON
- Audit `COMPLETED`

<details>
<summary><strong>Why this ladder matters</strong></summary>

This structure prevents infinite retries and forces explicit handling at each uncertainty boundary.

</details>
