services:
  app-postgres:
    image: postgres:16
    container_name: app-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: intake
    ports:
      - "5432:5432"
    volumes:
      - app_postgres_data:/var/lib/postgresql/data
      - ./db/migrations/001_init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro

  temporal-postgres:
    image: postgres:16
    container_name: temporal-postgres
    environment:
      POSTGRES_USER: temporal
      POSTGRES_PASSWORD: temporal
      POSTGRES_DB: temporal
    ports:
      - "5433:5432"
    volumes:
      - temporal_postgres_data:/var/lib/postgresql/data

  temporal:
    image: temporalio/auto-setup:1.26.2
    container_name: temporal
    depends_on:
      - temporal-postgres
    environment:
      DB: postgres12
      DB_PORT: 5432
      POSTGRES_USER: temporal
      POSTGRES_PWD: temporal
      POSTGRES_SEEDS: temporal-postgres
      DYNAMIC_CONFIG_FILE_PATH: /etc/temporal/config/dynamicconfig/development.yaml
    ports:
      - "7233:7233"
    volumes:
      - ./docker/temporal/dynamicconfig:/etc/temporal/config/dynamicconfig:ro

  temporal-ui:
    image: temporalio/ui:2.29.0
    container_name: temporal-ui
    depends_on:
      - temporal
    environment:
      TEMPORAL_ADDRESS: temporal:7233
    ports:
      - "8233:8080"

  minio:
    image: minio/minio:RELEASE.2024-12-18T13-15-44Z
    container_name: minio
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

  minio-setup:
    image: minio/mc:RELEASE.2024-11-21T17-21-54Z
    container_name: minio-setup
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set local http://minio:9000 minioadmin minioadmin;
      /usr/bin/mc mb --ignore-existing local/documents;
      exit 0;
      "

  api:
    image: golang:1.22
    container_name: intake-api
    working_dir: /app
    depends_on:
      - app-postgres
      - temporal
      - minio
    env_file:
      - .env
    environment:
      HTTP_PORT: 8080
      POSTGRES_DSN: postgres://postgres:postgres@app-postgres:5432/intake?sslmode=disable
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: document-intake-task-queue
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: documents
      MINIO_USE_SSL: "false"
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
    command: go run ./cmd/api
    volumes:
      - ./:/app
    ports:
      - "8080:8080"

  worker:
    image: golang:1.22
    container_name: intake-worker
    working_dir: /app
    depends_on:
      - app-postgres
      - temporal
      - minio
    env_file:
      - .env
    environment:
      POSTGRES_DSN: postgres://postgres:postgres@app-postgres:5432/intake?sslmode=disable
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_NAMESPACE: default
      TEMPORAL_TASK_QUEUE: document-intake-task-queue
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: documents
      MINIO_USE_SSL: "false"
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
    command: go run ./cmd/worker
    volumes:
      - ./:/app

  braintrust-eval:
    image: golang:1.25
    container_name: braintrust-eval
    working_dir: /app
    depends_on:
      - api
      - worker
    env_file:
      - .env
    environment:
      EVAL_API_URL: http://api:8080
      EVAL_CASES_PATH: /app/evals/braintrust/cases.json
      EVAL_AUTO_APPROVE_REVIEW: ${EVAL_AUTO_APPROVE_REVIEW:-false}
      EVAL_POLL_TIMEOUT_SEC: ${EVAL_POLL_TIMEOUT_SEC:-180}
      BRAINTRUST_API_KEY: ${BRAINTRUST_API_KEY:-}
      BRAINTRUST_PROJECT: ${BRAINTRUST_PROJECT:-temporal-llm-orchestrator}
    volumes:
      - ./:/app
    command: /bin/sh -lc "cd evals/braintrust && go mod download && go run ."
    profiles:
      - eval

volumes:
  app_postgres_data:
  temporal_postgres_data:
  minio_data:
